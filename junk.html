<!DOCTYPE html>
<html>
  <head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Smooth Scroll</title>
    <link href="styles.css" rel="stylesheet">
  </head>
  <body>
	<div id="main-scrollable-comp">
	  <div class='loader-container'>
		<div class='loader d-none'></div>
	  </div>
	  <div id='list'></div>
	  <div id="default-comp"></div>
	</div>
  </body>
  <script>
	var state = {
	  loadingMore: false,
	  docScrollHeight: 0,
	  lastCall: 0,
	  lastCallToFetch: 0,
	}

	var count = 0;

	function createEl () {
	  let el = document.createElement('div');
	  el.classList.add('list-comp');
	  let elNum = document.createElement('span');
	  elNum.textContent = count;
	  elNum.classList.add('elNum');
	  el.appendChild(elNum);
	  const listEl = document.querySelector('#list');
	  listEl.prepend(el);
	  count++;
	}

	function mockApi(lagDuration) {
	  return new Promise(resolve => {
		setTimeout(resolve, lagDuration)
	  });
	}

	function throttle(fetchCb, throttleDuration) {
	  let previousCall = state.lastCall;
	  state.lastCall = Date.now();

	  if (previousCall === undefined || (state.lastCall - previousCall) > throttleDuration) {
		console.log('inside normal throttle');
		state.lastCallToFetch = Date.now();
		state.loadingMore = true;
		document.querySelector('.loader').classList.remove('d-none');
		fetchCb(300)
		  .then(() => {
		   	createEl(); 
			state.loadingMore = false;
		  })
		  .then(() => {
			const {
			  scrollHeight
			} = document.documentElement;
			if (!state.loadingMore) {
			  window.scrollTo(0, scrollHeight - state.docScrollHeight);
			  document.querySelector('.loader').classList.add('d-none');
			}
		  });
	  } else if (state.lastCall - state.lastCallToFetch > 1200) {
		state.lastCallToFetch = Date.now();
		state.loadingMore = true;
		document.querySelector('.loader').classList.remove('d-none');
		fetchCb(300)
		  .then(() => { 
			createEl(); 
			state.loadingMore = false;
		  })
		  .then(() => {
			const {
			  scrollHeight
			} = document.documentElement;
			if (!state.loadingMore) {
			  window.scrollTo(0, scrollHeight - state.docScrollHeight);
			  document.querySelector('.loader').classList.add('d-none');
			}
		});
	  }
	}

	var onScrollList = function on_scroll_list() {
	  if (window.scrollY < 20) {
		if (!state.loadingMore) {
		  state.docScrollHeight = document.documentElement.scrollHeight;
		  state.loagingMore = true;
		  throttle(mockApi, 300);
		}
	  }
	}

	window.addEventListener('scroll', onScrollList);

	window.onload = function () {
	  window.scrollTo(0, document.body.clientHeight);
	}
  </script>
</html>
